<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - NYR Festas</title>
    <link rel="stylesheet" href="styles.css">
    <script src="scripts/loadComponents.js" defer></script>
</head>
<body>
    <header>
        <h1>NYR Festas</h1>
        <div id="user-info">
            <span id="username-display"></span>
            <button id="logoutBtn" aria-label="Logout do usuário">Logout</button>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="cadastro.html">Cadastro</a></li>
            <li><a href="produtos.html">Lista de Produtos</a></li>
            <li><a href="pedidos.html">Pedidos</a></li>
        </ul>
    </nav>

    <h1>Meus Pedidos</h1>

    <div id="orders-container">
        <!-- Orders will be inserted here dynamically -->
    </div>

    <script>
        // Function to load orders from the backend
        async function loadOrders() {
            console.log('loadOrders function started'); // Log function entry

            // Fetch username from localStorage
            const username = localStorage.getItem('username');
            console.log('Username from localStorage:', username); // Log the username from localStorage

            // Check if username exists
            if (!username) {
                console.log('No username found in localStorage');
                document.getElementById('orders-container').innerHTML = '<p>User not authenticated</p>';
                return;
            }

            try {
                console.log('Sending request to backend...');
                const response = await fetch('https://backendnyrfestas.vercel.app/orders?username=' + username, {
                    method: 'GET'
                });

                console.log('Response received:', response); // Log the raw response object

                // Check if the response is ok
                if (!response.ok) {
                    console.log('Failed to fetch orders. Status:', response.status, response.statusText);
                    document.getElementById('orders-container').innerHTML = '<p>Failed to load orders.</p>';
                    return;
                }

                const orders = await response.json();
                console.log('Parsed orders data:', orders); // Log the parsed JSON data
                displayOrders(orders);

            } catch (error) {
                console.error('Error fetching orders:', error); // Log any errors
                document.getElementById('orders-container').innerHTML = '<p>Failed to load orders.</p>';
            }
        }

        // Function to dynamically display orders
        function displayOrders(orders) {
            console.log('displayOrders function called with:', orders); // Log the input to this function
            const container = document.getElementById('orders-container');
            container.innerHTML = ''; // Clear existing content

            if (orders.length === 0) {
                console.log('No orders found'); // Log if no orders exist
                container.innerHTML = '<p>No orders found.</p>';
                return;
            }

            orders.forEach(order => {
                console.log('Processing order:', order); // Log each order being processed

                const statusText = order.status === 1 ? 'Submitted' : 'Draft';
                const orderRow = `
                    <div class="order-row">
                        <div class="order-details">
                            <div><strong>ID:</strong> ${order.id}</div>
                            <div><strong>Razão Social:</strong> ${order.razaosocial}</div>
                            <div><strong>Data:</strong> ${new Date(order.data).toLocaleDateString()}</div>
                            <div><strong>Total:</strong> R$ ${order.total.toFixed(2)}</div>
                            <div class="status"><strong>Status:</strong> ${statusText}</div>
                        </div>
                        <button class="view-button" onclick="viewOrder(${order.id})">Ver Detalhes</button>
                    </div>
                `;
                container.innerHTML += orderRow;
            });
            console.log('All orders displayed'); // Log when all orders are displayed
        }

        // Function to view order details (placeholder)
        function viewOrder(orderId) {
            console.log('View order called for ID:', orderId); // Log the ID of the order being viewed
            alert(`Visualizar detalhes do pedido ${orderId}`);
            // You can redirect to another page or show a modal with more details here
        }

        // Load orders when the page is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed'); // Log when the DOM is ready
            loadOrders();
        });

        // Handle login status
        const username = localStorage.getItem('username');
        if (username) {
            document.getElementById('username-display').textContent = `Bem-vindo, ${username}`;
        } else {
            alert("Você precisa estar logado para acessar esta página!");
            window.location.href = '/';
        }

        // Logout function
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('username');  // Remove login data
            window.location.href = '/';  // Redirect to login page
        });
    </script>
</body>
</html>
