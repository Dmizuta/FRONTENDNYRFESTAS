<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - NYR Festas</title>
    <link rel="stylesheet" href="styles.css">
    <script src="scripts/loadComponents.js" defer></script>
    <link rel="icon" type="image/png" href="/imagens/LOGO_NYR.png">

    <script src="config.js"></script>

    

 
    <style>

        .buttonsContainer {
            background-color: #f1f1f1;
            border: 2px solid #e2e2e2; /* Added 'solid' to define border */
            border-radius: 10px;
            margin-top: 20px;
            padding: 20px; /* Added padding to avoid content sticking to the border */
        }
        
        
        /* General container for all buttons */
        .allbtns {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        /* General button styles */
        .action-btn {
            padding: 10px 30px; /* Increased padding for a bigger button */
            font-size: 1rem; /* Larger font size for a more sophisticated look */
            font-weight: 600; /* Slightly bolder for emphasis */
            border: 2px solid transparent; /* Default border */
            border-radius: 12px; /* Softer rounded corners for a modern look */
            cursor: pointer;
            transition: all 0.3s ease;
            width: 180px; /* Uniform width for buttons */
            
            background-color: #007bff; /* Blue background */
            color: whitesmoke;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.274); /* Soft shadow for depth */
            font-family: 'Roboto', sans-serif; /* Clean and modern font */
            text-align: center;
            letter-spacing: 1px; /* Small space between letters for elegance */
        }
        
        /* Hover effect for action buttons */
        .action-btn:hover {
            background-color: #0069d9;
            border-color: #0056b3;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-3px); /* Slight lift effect on hover */
        }
        
        /* Active effect for action buttons */
        .action-btn:active {
            transform: scale(0.98);
            background-color: #0056b3;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        #close-modal {
            background-color: #f8f9fa;
            color: #333;
            border: 2px solid #007bff;
            font-size: 18px;
            padding: 14px 30px;
            border-radius: 12px;
            font-family: 'Roboto', sans-serif;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: min(90%, 4 * 180px + 3 * 20px); /* Shrinks with the container */
            transition: all 0.2s ease;
            max-width: 100%; /* Ensures it never overflows */
        }
        
        /* On smaller screens, make sure buttons adjust correctly */
        @media (max-width: 768px) {
            #close-modal {
                width: 100%; /* Takes full width when space is limited */
            }
        }
        
        
        /* Hover effect for the close button */
        #close-modal:hover {
            background-color: #e2e6ea;
            border-color: #0056b3; /* Darker blue border on hover */
            transform: translateY(-3px);
        }
        
        /* Active effect for the close button */
        #close-modal:active {
            transform: scale(0.98);
            background-color: #dae0e5;
        }
        
        /* Adding responsive styles for narrow screens */
        @media (max-width: 768px) {
            .modal-actions {
                flex-direction: column; /* Stack buttons vertically on small screens */
                gap: 15px;
            }
        }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
         .container {
                display: flex;
                flex-direction: column;
                align-items: self-start;
                gap: 10px;
                font-family: Arial, sans-serif;
            }
        
            /* Flexbox layout for labels and switch */
            .switch-container {
                display: flex;
                align-items: center;
                gap: 10px;
            }
        
            .switch-label {
                font-size: 16px;
                font-weight: bold;
                transition: color 0.3s;
            }
        
            /* Style for the toggle switch */
            .switch {
                position: relative;
                display: inline-block;
                width: 60px;
                height: 34px;
            }
            
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #4CAF50;
                transition: 0.4s;
                border-radius: 34px;
            }
            
            .slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 26px;    
                border-radius: 50%;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: 0.4s;
            }
            
            input:checked + .slider {
                background-color: #ccc;
            }
            
            input:checked + .slider:before {
                transform: translateX(26px);
            }
        
           
        
        
        /* Orders container */
        #orders-container {
                max-width: 95%;
                margin: 30px auto;
                padding: 20px;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }
            /* Order row layout */
            .order-row {
                display: flex;
                justify-content: space-between;
                padding: 15px;
                border-bottom: 1px solid #ddd;
                margin-bottom: 10px;
                background-color: #f9f9f9;
                border-radius: 5px;
                font-size: 1.1rem;
                cursor: pointer; /* Make the row clickable */
            }
            
            .order-details {
                display: flex;
                flex: 1;
                justify-content: space-between;
            }
            
            .order-details div {
                margin: 0 10px;
                font-size: 1rem;color: #333;
            }
            
            /* Status styling */
            .status {
                font-weight: bold;
                color: #007BFF;
            }
            
            .order-row:hover {
                background-color: #eef2f5;
            }
            
            /* Responsive layout for mobile */
            @media (max-width: 768px) {
                .order-row {
                    flex-direction: column;
                    align-items: flex-start;
                }
            
                .order-details {
                    flex-direction: column;
                }
            }
            
            /* Modal Styling */
        
            .modal {
            display: none;
            position: fixed;
           
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 60px 20px; /* Add padding to prevent content from touching edges */
        font-size: 1rem;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 1300px;
            max-height: 90vh; /* Limit height to 80% of viewport */
            overflow-y: auto; /* Enable vertical scrolling */
            animation: fadeIn 0.3s ease-in-out;
            margin: auto; /* Center modal on screen */
        }
        
            
            #logo-image {
                width: 20%;
                padding: 10px;
            }
            
            /*.close-btn {
                color: #aaa;
                font-size: 28px;
                font-weight: bold;
                position: absolute;
                top: 10px;
                right: 25px;
                border-color: #aaa;
                cursor: pointer;
            }
            
            .close-btn:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }*/
            
            #order-details-content {
                padding: 10px;
                text-align: center;
              
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
           
            
            .order-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 1.1rem;
            }
            
            .order-info {
                flex: 1;
            }
            
            .order-info-row {
                margin: 5px 0;
            }
            
            /* Modal table styling */
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            
            table th, table td {
                padding: 8px;
                text-align: center;
                border: 1px solid #ddd;
            }
            
            #order-items-body tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            
            #total-value {
            font-weight: bold;
            float: right;
            
        }
            /* When modal is open, make it visible */
            .modal.show {
                display: flex;
            }
            
            .totalOrderBox {
            
            padding: 20px 20px;
            margin: 20px auto;
            background-color: #13273d;
            color: white;
            border: none;
            border-radius: 5px;
        
        
        }
        
            /* Responsiveness for smaller screens */
            @media (max-width: 768px) {
                .order-header {
                    flex-direction: column;
                }
            
                .order-info {
                    margin-top: 20px;
                }
            }
            
            .obs-row {
            padding: 10px;
            background-color: #aaa;
            border-radius: 10px;
            font-size: 1rem;
          }
        
        
          textarea {
          width: 100%;
          padding: 10px;
          font-size: 1rem;
          border-radius: 4px;
          border: 1px solid #ccc;
          box-sizing: border-box;
          resize: none;
          line-height: 24px; /* Set line height to calculate row height */
          max-height: 120px; /* Limit to 3 rows (3 * 24px) */
          overflow-y: auto; /* Enable scrolling when the content exceeds max height */
        }
        
        
        
        
        
        
        
        /* Base styles for both buttons */
        .modalOrderDeleteButton, .modalOrderEditButton {
          width: 40px;                /* Set desired width */
          height: 40px;               /* Set desired height */
          cursor: pointer;           /* Indicate the buttons are clickable */
          transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth transition for transform and shadow */
        }
        
        .modalOrderEditButton img, .modalOrderDeleteButton img {
          vertical-align: super;     /* Align image properly */
          width: 20px;                /* Set image size */
          height: auto;               /* Keep aspect ratio */
        }
        
        /* Hover state for both buttons */
        .modalOrderDeleteButton:hover, .modalOrderEditButton:hover {
          transform: scale(1.1);  /* Slightly grow the button on hover */
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Add a soft shadow for depth */
        }
        
        /* Optional: active state to shrink the button slightly when clicked */
        .modalOrderDeleteButton:active, .modalOrderEditButton:active {
          transform: scale(0.98);  /* Shrink the button a bit when clicked */
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Lighter shadow on active state */
        }
        
        
        
        
        
        
        
        
          .save-quantity-btn {
            background-color: #28a745;
            width: 5rem;
            display: block; 
            margin: 0.5rem auto 0; /* Top margin, center ali
            gnment, no bottom margin */
        }
        .save-quantity-btn:hover {
            background-color: #6aa277; /* Yellow-orange hover color */
            transform: scale(1.03); /* Aumenta o tamanho do elemento em 10% */
        }
        
        .edit-quantity {
            padding: 10px;
            font-size: 1rem;
            border: 2px solid #007BFF; /* Optional: blue border */
            border-radius: 8px;
            width: 5rem; /* Adjust width if necessary */
            text-align: center;
        }
        
        .order-total{
            font-size: 1.1rem;
        }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
            
                /* Style for the dropdown container */
                .dropdown {
                margin: 20px 0;
                font-family: Arial, sans-serif;
            }
            
            /* Style for the label */
            .dropdown label {
                font-size: 1rem;
                font-weight: bold;
                color: #333;
                display: block;
                margin-bottom: 5px;
            }
            
            /* Style for the select dropdown */
            #ipi {
                width: 100%;
                padding: 8px;
                font-size: 1rem;
                color: #333;
                background-color: #f0f0f0;
                border: 1px solid #ccc;
                border-radius: 5px;
                outline: none;
                transition: border-color 0.3s ease;
            }
            
            /* Focus effect for the select input */
            #ipi:focus {
                border-color: #BF6734;
            }
            
            /* Style for the options inside the dropdown */
            #ipi option {
                padding: 10px;
                background-color: #fff;
            }
            
            /* Hover effect for the dropdown */
            #ipi:hover {
                border-color: #BF6734;
            }
            
            /* Style for the select box container when it's not focused */
            .dropdown {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                
                width: 100px;
                margin: 20px 0;
                padding-right: 30px;
            }
            
            
            /* By default, hide the print-only span*/ 
            .ipi-print-only {
                
                display: none;
                
            }
            
            
            
            .topButtons {
                display: flex;        /* Enables flexbox */
                justify-content: space-between; /* Distributes space between the two divs */
                align-items: center;  /* Aligns items vertically in the center */
                gap: 10px;            /* Adds space between the two divs (optional) */
            }
            
            .topButtons > div {
                flex: 1; /* Makes both divs take equal space */
            }
</style>



</head>




<body>

   
<header>
    <h1 id="nyrfestas"></h1>
    <div id="user-info">
        <span id="username-display"></span>
        <button id="logoutBtn" aria-label="Logout do usuário">Sair</button>
    </div>


    <div class="logoNyr">
        <img id="logo" src="/imagens/LOGO.png" alt="LOGO">
    </div>


</header>

<div class="PAGE">



<nav>
    <ul>
        <li><a href="CADASTRO/CADASTRO_USER/cadastro.html">Cadastro</a></li>
        <li><a href="produtos.html">Lista de Produtos</a></li>
        <li><a href="pedidos.html">Pedidos</a></li>
    </ul>
</nav>

<h1>Meus Pedidos</h1>

<div id="orders-container">
    <!-- Orders will be inserted here dynamically -->
</div>





<!-- Modal Structure (Initially hidden) -->
<div id="order-modal" class="modal">
    <div class="modal-content">
        <!-- Header Section with Order Information -->
        <div class="order-header">
            <div class="order-info">
                <div class="order-info-row">
                    <span>Numero do Pedido:</span>
                    <span id="order-id"></span>
                </div>
                <div class="order-info-row">
                    <span>Razao Social:</span>
                    <span id="razao-social"></span>
                </div>
                <div class="order-info-row">
                    <span>CNPJ:</span>
                    <span id="cnpj"></span>
                </div>
                <div class="order-info-row">
                    <span>Representante:</span>
                    <span id="representante"></span>
                </div>
                
               

            </div>
            <img src="/imagens/LOGO_NYR.png" alt="Logo" id="logo-image">
        </div>

        <!-- Table with Product Details -->
        <table id="order-items-table">
            <thead>
                <tr>
                    <th>-</th>
                    <th>Código</th>
                    <th>Descrição</th>
                    <th>Qtde</th>
                    <th>Preço Unitário</th>
                    <th>Ipi</th>
                    <th>Subtotal</th>
                    <th>Editar</th>
                    <th>Apagar</th>
                </tr>
            </thead>
            <tbody id="order-details-content">
                <!-- Product rows will be dynamically populated here -->
            </tbody>
        </table>

<div class="totalOrderBox">
        <!-- Total Order Section -->
        <div class="order-total">
            <div>
                <span>Total do Pedido:</span>
                <span id="total-value">R$ 0,00</span>
            </div>
        </div>



    </div>



    <div class="obs-row">
        <span>Observações:</span>
        <textarea type="text" id="obs"
        placeholder=
        "OBRIGATÓRIO: Transportadora / Forma de pagamento / Nf"
        ></textarea>
    </div>




  




        <!-- Action Buttons -->
         <div class="allbtns">
        <div class="modal-actions">
            <button class="action-btn" onclick="printOrder()">Imprimir</button>
            <button id="save-notes-btn" class="action-btn">Salvar</button>
           <!-- <button id="submit-order-btn" class="action-btn">Orçamento</button>-->
            <button id="finish-order-btn" class="action-btn">Status</button>
            <!--<button id="revert-order-btn" class="action-btn">Reverter</button>-->





            <!-- <button id="submit-order-btn" class="action-btn">Salvar</button>-->


            <button id="delete-order-btn" class="action-btn">Apagar</button>
        </div>
        
        <!-- Close Modal Button -->
        <button id="close-modal" class="action-btn">Fechar</button>
    </div>
</div>
</div>

</div>


















<script>





////////////////////////////////////////////////////////////////////////////////////////////////////////



// Handle login status
const username = localStorage.getItem('username');
if (username) {
    document.getElementById('username-display').textContent = `Bem-vindo, ${username}`;
} else {
    alert("Você precisa estar logado para acessar esta página!");
    window.location.href = '/';
}

// Logout function
document.getElementById('logoutBtn').addEventListener('click', function() {
    localStorage.removeItem('username');
    window.location.href = '/';
});


////////////////////////////////////////////////////////////////////////////////////////////////////////



// Function to load orders from the backend
async function loadOrders() {
    console.log('loadOrders function started');

    // Fetch username from localStorage
    const username = localStorage.getItem('username');
    console.log('Username from localStorage:', username);

    // Check if username exists
    if (!username) {
        console.log('No username found in localStorage');
        document.getElementById('orders-container').innerHTML = '<p>User not authenticated</p>';
        return;
    }

    try {
        console.log('Sending request to backend...');
        const response = await fetch(`${URL_API}/userorders?username=` + username, {
            method: 'GET'
        });

        console.log('Response received:', response);

        // Check if the response is ok
        if (!response.ok) {
            console.log('Failed to fetch orders. Status:', response.status, response.statusText);
            document.getElementById('orders-container').innerHTML = '<p>Failed to load orders.</p>';
            return;
        }

        const orders = await response.json();
        console.log('DADOS DO PEDIDO:', orders);
        displayOrders(orders);

    } catch (error) {
        console.error('Error fetching orders:', error);
        document.getElementById('orders-container').innerHTML = '<p>Failed to load orders.</p>';
    }
}




// Function to dynamically display orders
function displayOrders(orders) {
    console.log('displayOrders function called with:', orders);
    const container = document.getElementById('orders-container');
    container.innerHTML = ''; // Clear existing content

    if (orders.length === 0) {
        console.log('No orders found');
        container.innerHTML = '<p>Nenhum pedido encontrado.</p>';
        return;
    }

    orders.forEach(order => {
        console.log('Processing order:', order);

        // Ensure the total is a valid number and handle non-numeric values
        const total = parseFloat(order.total);
        if (isNaN(total)) {
            console.error('Invalid total value:', order.total);
        }





// Function to format numbers as currency (Brazilian Real - R$)
function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
}






const statusMap = {
    0: { text: 'Aberto', color: '#E07A5F' },
    1: { text: 'Orçamento', color: '#FFB200' },
    2: { text: 'Fechado', color: '#6EC207' },
    3: { text: 'Processado', color: '#3D8D7A' }
};

// Get status text and color
const status = statusMap[order.status] || { text: 'Unknown', color: 'gray' };

const orderRow = `
    <div class="order-row" data-id="${order.id}">
        <div class="order-details">
            <div><strong>ID:</strong> ${order.id}</div>
            
            <div><strong>Razão Social:</strong> ${order.razaosocial}</div>
            <div><strong>Data:</strong> ${new Date(order.data).toLocaleDateString()}</div>
            <div><strong>Total:</strong> R$ ${formatCurrency(order.total)}</div>
            <div class="status" style="color: ${status.color};">
                <strong>Status:</strong> ${status.text}
            </div>
        </div>
    </div>
`;

container.innerHTML += orderRow;











/*
const statusText = order.status === 0 ? 'Aberto' :
                   order.status === 1 ? 'Orçamento' :
                   order.status === 2 ? 'Fechado' :
                   order.status === 3 ? 'Fechado' :
                   'Unknown'; 


       
        const orderRow = `
            <div class="order-row" data-id="${order.id}">
                <div class="order-details">
                    <div><strong>ID:</strong> ${order.id}</div>
                    <div><strong>Razão Social:</strong> ${order.razaosocial}</div>
                    <div><strong>Data:</strong> ${new Date(order.data).toLocaleDateString()}</div>
                    <div><strong>Total:</strong> R$ ${formatCurrency(order.total)}</div>
                    <div class="status"><strong>Status:</strong> ${statusText}</div>
                </div>
            </div>
        `;
        container.innerHTML += orderRow;


        */
    });
    console.log('All orders displayed');
}











// Load orders when the page is ready
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM fully loaded and parsed');
    loadOrders();
});



// Get the modal element
const modal = document.getElementById("order-modal");
const closeModalBtn = document.getElementById("close-modal");





////////////////////////////////////////////////////////////////////////////////////////////////////////
        
document.getElementById("orders-container").addEventListener("click", function(event) {
    if (event.target && event.target.closest(".order-row")) {
        const orderRow = event.target.closest(".order-row");
        const orderId = orderRow.getAttribute("data-id");
        fetchOrderDetails(orderId);
        document.getElementById("order-modal").style.display = "block";
        console.log("CHECK HERE 01", orderId);
    }
});

// Event listener for closing the modal
closeModalBtn.addEventListener("click", function() {
    modal.style.display = "none";
});

/* When the user clicks anywhere outside of the modal, close it*/
window.addEventListener("click", function(event) {
    if (event.target === modal) {
        modal.style.display = "none";
    }
});




// Function to fetch and display order details in the modal
async function fetchOrderDetails(orderId) {
    console.log("CHECK HERE 02", orderId);
    try {
        console.log(`Fetching details for order ID: ${orderId}`);
        const response = await fetch(`${URL_API}/order-details/${orderId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch order details');
        }
        const orderDetails = await response.json();

        const orderID = orderDetails.id;
        localStorage.setItem('currentOrderId', orderID);

        console.log('Order details received:', orderDetails);
        populateModal(orderDetails);
    } catch (error) {
        console.error('Error fetching order details:', error);
    }
}

// Function to format numbers as currency (Brazilian Real - R$)
function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
}



// Function to populate the modal with order details
function populateModal(orderDetails) {
    // Update general order information in the modal
    document.getElementById('order-id').textContent = orderDetails.id;
    document.getElementById('razao-social').textContent = orderDetails.razaosocial;
    document.getElementById('cnpj').textContent = orderDetails.cnpj;
    document.getElementById('representante').textContent = orderDetails.representante;
    document.getElementById('obs').textContent = orderDetails.observacoes;

    // Update products table and calculate total
    const orderDetailsContent = document.getElementById('order-details-content');
    let total = 0; // Variable to accumulate the total price    

    // Clear existing content and rebuild the table
    orderDetailsContent.innerHTML = ''; // Clear content initially
    orderDetails.products.forEach((product, index) => {
        const price = parseFloat(product.preco); // Ensure price is a number
        const quantity = parseInt(product.quantidade, 10); // Ensure quantity is an integer
        const factor = parseInt(product.ipi);

       
        const ipi = factor * 0.13 * price * quantity;
        
        const productTotal = (price * quantity) + ipi; // Calculate product total

        const row = `
            <tr data-product-id="${product.id}">
                <td>${index + 1}</td>
                <td>${product.codproduto}</td>
                <td>${product.descricao}</td>
                <td class="quantity">${quantity}</td> <!-- Add 'quantity' class for easy selection -->
                <td>${formatCurrency(price)}</td>
                <td>${formatCurrency(ipi)}</td>
                <td>${formatCurrency(productTotal)}</td>
                <td><button class="modalOrderEditButton"><img src="/imagens/pencil.png" alt="Editar"></button></td>
                <td><button class="modalOrderDeleteButton"><img src="/imagens/trashcan.png" alt="Apagar"></button></td>
            </tr>
        `;  
        orderDetailsContent.innerHTML += row; // Add row to table

        total += productTotal; // Accumulate the product total to the overall total
    });

    // Update total price in the modal
    document.getElementById('total-value').textContent = formatCurrency(total); // Display the total value




////////////////////////////////////////////////////////////////////////////////////////////////////////







// Add event listeners for edit buttons
document.querySelectorAll('.modalOrderEditButton').forEach((button) => {
    button.addEventListener('click', async function () {
        const row = this.closest('tr');

        const orderId = localStorage.getItem('currentOrderId');
        const quantityCell = row.querySelector('.quantity');
        const productId = row.getAttribute('data-product-id');
        const currentQuantity = parseInt(quantityCell.textContent.trim(), 10);

        // Fetch the current order status to determine if it's editable
        const requestData = { orderId };
        console.log("currentOrderId:", orderId);

        try {
            const response = await fetch(`${URL_API}/orderStatus`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(requestData),
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch order status: ${response.statusText}`);
            }

            const data = await response.json();

            // Check if the order status is fetched properly
            const orderStatus = data.status; // Adjust based on backend response format
            console.log("Order Status:", orderStatus);

            if (orderStatus === 2) {
                alert("NÃO É POSSÍVEL EDITAR O PRODUTO, PEDIDO ENVIADO OU PROCESSADO.");
                return; // Prevent further execution
            }

            // If order is editable, proceed with making the quantity editable
            const inputField = document.createElement('input');
            inputField.type = 'number';
            inputField.value = currentQuantity;
            inputField.classList.add('edit-quantity');

            // Add save button
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Salvar';
            saveButton.classList.add('save-quantity-btn');

            // Clear the quantity cell and append input and save button
            quantityCell.innerHTML = '';
            quantityCell.appendChild(inputField);
            quantityCell.appendChild(saveButton);

            // Focus the input field immediately after it is appended
            inputField.focus();

            // Add 'Enter' key support
            inputField.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') saveButton.click();
            });

            saveButton.addEventListener('click', async function () {
                const newQuantity = parseInt(inputField.value, 10);
                if (newQuantity && newQuantity > 0) {
                    try {
                        const response = await fetch(`${URL_API}/editproduct/${productId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ quantity: newQuantity })
                        });

                        if (!response.ok) throw new Error('Failed to update quantity');


        
                        const data = await response.json();
// Assume 'data' is the response object you received from the server
// const data = response.data;

// Retrieve the ipi value and total from the response
const ipi = data.updatedProduct.ipi;  // ipi value
const updatedTotal = data.updatedProduct.total;  // New total value

console.log('IPI value:', ipi);
console.log('Updated total:', updatedTotal);


                        // Update the quantity directly in the table after success
                        quantityCell.textContent = newQuantity;

                        // Optionally, you can re-calculate the total if necessary
                        const price = parseFloat(row.cells[4].textContent.replace(/[^\d.-]/g, '').trim()); // Remove any non-numeric characters
                        const ipiValue = ipi * 0.13 * price / 100 * newQuantity; 
                        const productTotal = price / 100 * newQuantity + ipiValue ;

                        // Update the total for this row
                        row.cells[5].textContent = formatCurrency(ipiValue);
                        row.cells[6].textContent = formatCurrency(productTotal); // Ensure it's formatted properly

                        // Update the total price in the modal
                        //update();
                        updateTotalPrice();

                       

                    } catch (error) {
                        alert('Error updating quantity');
                        console.error('Error updating quantity:', error);
                    }
                } else {
                    alert('ADICIONE UMA QUANTIDADE VÁLIDA.');
                }
            });
        } catch (error) {
            console.error('Error fetching order status:', error);
            alert('An error occurred while checking the order status. Please try again later.');
        }
    });
});




////////////////////////////////////////////////////////////////////////////////////////////////////////

// Function to update the total price in the modal
function updateTotalPrice() {
    const rows = document.querySelectorAll('#order-details-content tr');
    let total = 0; // Starting with an initial value of 1000
    
    rows.forEach(row => {

        const productTotal = parseFloat(
    row.cells[6].textContent
        .replace('R$', '')
        .trim()
        .replace(/\./g, '') // Remove ALL dots
        .replace(',', '.')  // Convert decimal separator
);
/*
        const productTotal = parseFloat(row.cells[6].textContent.replace('R$', '').trim().replace('.', '').replace(',', '.'));
        console.log('resultado total', productTotal)
*/

total =  total += productTotal;
    });

    // Round the total to 2 decimal places
   // total = total.toFixed(2); // This will convert it to a string with 2 decimals
    
 document.getElementById('total-value').textContent = formatCurrency(total);}




////////////////////////////////////////////////////////////////////////////////////////////////////////

    // Add event listeners for delete buttons
    document.querySelectorAll('.modalOrderDeleteButton').forEach((button) => {
        button.addEventListener('click', async (event) => {
            event.stopPropagation(); // Prevent row click interference
            const row = button.closest('tr');
            const productId = row.getAttribute('data-product-id');
            await deleteProduct(productId, orderDetails.id);
        });
    });
}



////////////////////////////////////////////////////////////////////////////////////////////////////////







// Function to delete a product
async function deleteProduct(productId, orderId) {
    // Fetch the current order status to determine if it's editable
    const requestData = { orderId };
    console.log("currentOrderId:", orderId);

    try {
        const statusResponse = await fetch(`${URL_API}/orderStatus`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
        });

        if (!statusResponse.ok) {
            throw new Error(`Failed to fetch order status: ${statusResponse.statusText}`);
        }

        const statusData = await statusResponse.json();

        // Check the order status
        const orderStatus = statusData.status; // Adjust based on backend response format
        console.log("Order Status:", orderStatus);

        if (orderStatus === 2) {
            alert("NÃO É POSSÍVEL DELETAR O PRODUTO, PEDIDO ENVIADO OU PROCESSADO.");
            return; // Stop further execution if status doesn't allow editing
        }

        // If status allows, proceed with deletion
        const response = await fetch(`${URL_API}/delete-product`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json', // Define content type as JSON
            },
            body: JSON.stringify({ productId, orderId }), // Send product and order ID in request body
        });

        if (!response.ok) {
            throw new Error('Failed to delete product');
        }

        console.log(`Product with ID ${productId} deleted successfully.`);
        alert('PRODUTO DELETADO COM SUCESSO.');

        // Refresh order details to reflect changes
        fetchOrderDetails(orderId);
    } catch (error) {
        console.error('Error deleting product:', error);
        alert('An error occurred. Please try again.');
    }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////

// Show modal with order details
function openModal(orderId) {
    fetchOrderDetails(orderId)
        .then(orderDetails => {
            populateModal(orderDetails); // Populate modal with fetched details
            document.getElementById('order-modal').classList.add('show'); // Show modal
        })
        .catch(error => console.error('Error fetching order details:', error));
}

// Event listener for order rows
document.querySelectorAll('.order-row').forEach(row => {
    row.addEventListener('click', () => {
        const orderId = row.getAttribute('data-id');
        openModal(orderId); // Open modal with clicked order details
    });
});

// Close modal functionality
document.getElementById('close-modal').addEventListener('click', () => {
    document.getElementById('order-modal').classList.remove('show'); // Hide modal
});



////////////////////////////////////////////////////////////////////////////////////////////////////////



const textarea = document.getElementById('obs');

textarea.addEventListener('input', () => {
  // Reset height to shrink if text is deleted
  textarea.style.height = 'auto';
  // Set height based on scrollHeight to expand as needed
  textarea.style.height = `${textarea.scrollHeight}px`;
});




////////////////////////////////////////////////////////////////////////////////////////////////////////


// Save Notes Button
document.getElementById("save-notes-btn").addEventListener("click", async () => {
    const observation = document.getElementById("obs").value.trim(); // Get the observation value
    const orderId = localStorage.getItem('currentOrderId'); // Get current order ID

    if (!orderId) {
        alert("No draft order found to save notes.");
        return;
    }

    const requestData = {
        orderId: orderId,
        observation: observation,
    };

    try {
        const response = await fetch(`${URL_API}/save-notes`, {
            method: "PATCH", // Use PATCH to indicate partial update
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
        });

        if (response.ok) {
            alert('PEDIDO SALVO COM SUCESSO!');
        } else {
            console.error("Falha ao salvar pedido.");
            alert('Ocorreu um erro, tente novamente.');
        }
    } catch (error) {
        console.error("Erro:", error);
    }
});




////////////////////////////////////////////////////////////////////////////////////////////////////////

document.getElementById("delete-order-btn").addEventListener("click", async () => {
    const orderId = localStorage.getItem('currentOrderId');

    // Fetch the current order status to determine if it's deletable
    const requestData = { orderId };
    console.log("currentOrderId:", orderId);

    try {
        const statusResponse = await fetch(`${URL_API}/orderStatus`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
        });

        if (!statusResponse.ok) {
            throw new Error(`Failed to fetch order status: ${statusResponse.statusText}`);
        }

        const statusData = await statusResponse.json();

        // Check the order status
        const orderStatus = statusData.status; // Adjust based on backend response format
        console.log("Order Status:", orderStatus);

        if (orderStatus === 2) {
            alert("NÃO É POSSÍVEL DELETAR O PEDIDO, POIS ELE FOI ENVIADO OU PROCESSADO.");
            return; // Stop further execution if status doesn't allow deletion
        }

        // Confirmation dialog
        const confirmDelete = confirm("TEM CERTEZA QUE DESEJA APAGAR ESTE PEDIDO? ESTA AÇÃO NÃO PODERÁ SER DESFEITA.");
        if (!confirmDelete) {
            // If the user cancels, stop the function
            return;
        }

        // Prepare data to send
        const deleteRequestData = {
            orderId: orderId, // Use the same key as in the backend
        };

        // Send a DELETE request to delete the order
        const deleteResponse = await fetch(`${URL_API}/delete-order`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(deleteRequestData),
        });

        if (deleteResponse.ok) {
            alert('PEDIDO DELETADO COM SUCESSO!');

            // Refresh the page
            window.location.reload();
            console.log("Order successfully deleted!");
        } else {
            console.error("Falha ao deletar o pedido.");
            alert('An error occurred. Please try again later.');
        }
    } catch (error) {
        console.error("Error handling the delete order action:", error);
    }
});





////////////////////////////////////////////////////////////////////////////////////////////////////////


/*
document.getElementById("submit-order-btn").addEventListener("click", async () => {
    const observation = document.getElementById("obs").value.trim(); // Get the observation value
    const orderId = localStorage.getItem('currentOrderId');

    // Validate if orderId exists and observation is not empty
    if (!orderId) {
        alert('Order ID is missing. Please try again.');
        return; // Stop further execution if orderId is not found
    }


    try {
        // Fetch the current status of the order
        const statusResponse = await fetch(`${URL_API}/orderStatus`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId }),
        });

        const statusData = await statusResponse.json();
        if (!statusData || statusData.status === undefined) {
            console.error("Invalid response:", statusData);
            return;
        }

        const currentStatus = statusData.status;

        // Block function if status is 2
        if (currentStatus === 2) {
            alert('O PEDIDO JÁ FOI FINALIZADO E NÃO PODE SER ALTERADO.');
            return; // Stop execution
        }

      

        // Prepare data to send
        const requestData = {
            orderId: orderId,
            observation: observation,
        };

        console.log(orderId, observation);

        // Send a POST request to update the order
        const response = await fetch(`${URL_API}/submit-order`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
        });

        if (response.ok) {
            alert('PEDIDO FOI ENVIADO COM SUCESSO!');
            // Refresh the page
            window.location.reload();
            console.log("Order successfully submitted!");
        } else {
            console.error("Failed to submit the order.");
            alert('An error occurred. Please try again later.');
        }
    } catch (error) {
        console.error("Error submitting the order:", error);
    }
});*/



////////////////////////////////////////////////////////////////////////////////////////////////////////



function printOrder() {
    const modalContent = document.querySelector('#order-modal').outerHTML; // Get all modal content
    const printWindow = window.open('', '', 'width=800,height=600'); // Open new print window

    // Inject the necessary print styles directly into the print window
    printWindow.document.write('<html><head><title>Print Order</title>');
    printWindow.document.write('<style>');
    printWindow.document.write(`
     @media print {
    /* General Page Style */
    body {
        font-family: Arial, sans-serif;
        font-size: 12pt;
        line-height: 1.5;
    }

    /* Logo styling */
    #logo-image {
        display: block;
        margin: 0 auto 20px;
        max-width: 200px;
    }

    /* Hide unnecessary columns and buttons */
    #logo-image,
     #order-items-table th:nth-child(8),
    #order-items-table td:nth-child(8),
    #order-items-table th:nth-child(9),
    #order-items-table td:nth-child(9),
    .allbtns,
    #submit-order-btn,
    #delete-order-btn,
    #close-modal {
        display: none !important;
    }

    /* Table Style */
    #order-items-table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
        page-break-inside: auto; /* Prevent breaks inside the table */
    }

    #order-items-table th, #order-items-table td {
        padding: 8px;
        text-align: left;
        border: 1px solid #ddd;
    }

    /* Make the total order section distinct */
    .totalOrderBox {
        margin-top: 20px;
        font-size: 14pt;
        font-weight: bold;
        border-top: 2px solid #000;
        padding-top: 10px;
        page-break-inside: avoid; /* Ensure the section stays together */
    }

    /* Observations Section */
    .obs-row {
        font-size: 11pt;
        margin-top: 20px;
        padding: 10px;
        background-color: #f9f9f9;
        page-break-inside: avoid; /* Prevent breaks in the observation area */
    }

    .obs-row textarea {
        width: 100%;
        font-size: 11pt;
        border: 1px solid #ddd;
        padding: 5px;
        box-sizing: border-box;
        resize: none; /* Disable resizing during print */
        white-space: pre-wrap; /* Ensure text wraps within the textarea */
        overflow: visible; /* Allow for overflow in the print view */
        min-height: 160px; /* Set a reasonable minimum height */
        height: auto !important; /* Allow it to expand to fit content */
        
    }

    /* Section Spacing */
    .order-header {
        margin-bottom: 20px;
        page-break-inside: avoid; /* Prevent break inside header */
    }

    /* Ensure good readability */
    .order-info-row span {
        font-weight: bold;
    }

    table {
        font-size: 10pt;
    }

    /* Remove block-style page breaks, allow natural flow */
    .order-info, .order-total {
        page-break-after: auto; /* Let content flow naturally */
    }

    /* Adjust table column width */
    #order-items-table th:nth-child(2), #order-items-table td:nth-child(2) {
        width: 15%;
    }

    #order-items-table th:nth-child(3), #order-items-table td:nth-child(3) {
        width: 40%;
    }

    #order-items-table th:nth-child(4), #order-items-table td:nth-child(4) {
        width: 10%;
    }

    #order-items-table th:nth-child(5), #order-items-table td:nth-child(5) {
        width: 15%;
    }

    #order-items-table th:nth-child(6), #order-items-table td:nth-child(6) {
        width: 15%;
    }
}



    `);
    printWindow.document.write('</style></head><body>');
    printWindow.document.write(modalContent); // Insert modal content into the print window
    printWindow.document.write('</body></html>');
    printWindow.document.close(); // Close the document to ensure all content is loaded
    printWindow.print(); // Trigger the print dialog
}






////////////////////////////////////////////////////////////////////////////////////////////////////////




/*
document.getElementById("revert-order-btn").addEventListener("click", async function () {
    const orderId = localStorage.getItem('currentOrderId');

    // Get the current order's status
    const requestData = { orderId };

    try {
        // Fetch the order status from the backend
        const response = await fetch(`${URL_API}/orderStatus`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
        });

        const data = await response.json();

        // Log the fetched data to see its structure
        console.log(data);

        // Ensure that data has a valid structure and contains a status field
        if (data && data.status !== undefined) {
            const orderStatus = data.status; // Get the status of the order

            console.log("Order Status:", orderStatus);

            // Block revert if the order status is 2
            if (orderStatus === 2) {
                console.log("Order has been processed. Reverting is not allowed.");
                alert("O PEDIDO JÁ FOI FINALIZADO E NÃO PODE SER ALTERADO.");
                return; // Stop execution here
            }

            if (orderStatus === 0) {
                // If the status is already 0 (draft), no need to revert
                console.log("ESTE PEDIDO JÁ ESTÁ ABERTO.");
                alert("ESTE PEDIDO JÁ ESTÁ ABERTO.");
            } else {
                // If the status is 1 (submitted), check if the user has other "Aberto" orders
                const checkResponse = await fetch(`${URL_API}/checkOtherOpenedOrders`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ username: localStorage.getItem('username') }), // or fetch username from session
                });

                const checkData = await checkResponse.json();

                // If no other opened orders, allow reverting
                if (checkData && checkData.canRevert) {
                    console.log("No other 'Aberto' orders. Proceeding with revert.");
                    // Call your backend API to revert the order
                    await fetch(`${URL_API}/revertOrder`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ orderId }),
                    });

                    console.log("Order reverted to 'Aberto' state.");
                    alert("STATUS DO PEDIDO REVERTIDO COM SUCESSO!");
                } else {
                    console.log("ORDEM NÃO PODE SER ALTERADA, EXISTE OUTRA ORDEM EM 'Aberto'.");
                    alert("O STATUS NÃO PODE SER REVERTIDO NO MOMENTO, EXISTE OUTRO PEDIDO EM 'ABERTO.'");
                }
            }
        } else {
            console.error("Invalid data returned:", data);
        }
    } catch (error) {
        console.error("Error fetching order status:", error);
    }

    window.location.reload();
});
*/
   
////////////////////////////////////////////////////////////////////////////////////////////////////////



document.getElementById("finish-order-btn").addEventListener("click", async () => {
    const orderId = localStorage.getItem('currentOrderId');
    const observation = document.getElementById("obs").value.trim(); // Get the observation field value









/*
    document.getElementById("toggleButton").addEventListener("change", async (event) => {
    const orderId = localStorage.getItem('currentOrderId');
    const observation = document.getElementById("obs").value.trim(); // Get the observation value*/

    if (!orderId) {
        alert('Order ID is missing. Please try again.');
        return;
    }


    try {
        // Fetch the current status of the order
        const response = await fetch(`${URL_API}/orderStatus`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId }),
        });

        const data = await response.json();
        if (!data || data.status === undefined) {
            console.error("Invalid response:", data);
            return;
        }

        const currentStatus = data.status;

        if (currentStatus === 0) {
            // Order is 'Aberto', proceed to submit (change to 'Orçamento')
            const submitResponse = await fetch(`${URL_API}/submit-order`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderId, observation }), // Send both orderId and observation
            });

            if (submitResponse.ok) {
                alert('PEDIDO FOI ENVIADO PARA ORÇAMENTO COM SUCESSO!');
            } else {
                alert('Ocorreu um erro ao enviar o pedido.');
                event.target.checked = false; // Reset the toggle switch on error
            }
        } 
        
        else if (currentStatus === 1) {
            // Order is 'Orçamento', check if revert is allowed
            const checkResponse = await fetch(`${URL_API}/checkOtherOpenedOrders`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: localStorage.getItem('username') }),
            });

            const checkData = await checkResponse.json();
            if (checkData && checkData.canRevert) {
                await fetch(`${URL_API}/revertOrder`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId }),
                });

                alert("STATUS DA ORDEM REVERTIDO PARA 'ABERTO' COM SUCESSO!");
            } else {
                alert("O STATUS NÃO PODE SER REVERTIDO NO MOMENTO, EXISTE OUTRA ORDEM EM 'ABERTO.'");
                event.target.checked = false; // Reset the toggle switch if revert isn't allowed
            }
        } 
        
        else if (currentStatus === 2) {
            alert("O STATUS NÃO PODE SER ALTERADO, A ORDEM JÁ ESTÁ FECHADA.");
            event.target.checked = false; // Reset the toggle switch if order is closed
        }

    } catch (error) {
        console.error("Error:", error);
        alert("Ocorreu um erro ao processar a solicitação.");
        event.target.checked = false; // Reset the toggle switch on error
    }

    window.location.reload();
});






/*

    // Validate if orderId exists
    if (!orderId) {
        alert('Order ID is missing. Please try again.');
        return;
    }

    // Check if observation is filled
    if (!observation) {
        alert('FAVOR INSERIR DADOS DE TRANSPORTADORA E FORMA DE PAGAMENTO NO CAMPO "OBSERVAÇÕES"');
        return; // Stop if observation is empty
    }

    try {
        // Fetch the current status of the order
        const response = await fetch(`${URL_API}/orderStatus`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId }),
        });

        const data = await response.json();
        if (!data || data.status === undefined) {
            console.error("Invalid response:", data);
            return;
        }

        const currentStatus = data.status;

        // Block function if status is 2
        if (currentStatus === 2) {
            alert('O PEDIDO JÁ FOI FINALIZADO E NÃO PODE SER ALTERADO.');
            return; // Stop execution
        }

        // Confirmation before proceeding with the status change
        const userConfirmed = window.confirm('TEM CERTEZA QUE DESEJA FINALIZAR ESTE PEDIDO? ESTA AÇÃO É IRREVERSÍVEL.');
        if (!userConfirmed) {
            return; // Stop if the user cancels
        }

        // Proceed to change status to 2 (Fechado) if the order is in status 0 or 1
        if (currentStatus === 0 || currentStatus === 1) {
            const finishResponse = await fetch(`${URL_API}/finishOrder`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderId, observation }), // Send the observation with the request
            });

            if (finishResponse.ok) {
                alert('PEDIDO FINALIZADO COM SUCESSO!');
            } else {
                alert('OCORREU UM ERRO.');
            }
        } else {
            alert('O PEDIDO JÁ FOI FINALIZADO.');
        }

    } catch (error) {
        console.error("Error:", error);
        alert("OCORREU UM ERRO.");
    }

    window.location.reload();
});

*/


</script>
<footer>
    <p>&copy; 2025 | NYR Festas</p>
  </footer>
</body>
</html>
