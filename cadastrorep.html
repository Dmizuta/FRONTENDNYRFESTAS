<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Cliente</title>
</head>
<body>
    <h1>Cadastrar Novo Cliente</h1>
    <form id="cadastroForm">
        <label for="representante">Representante:</label>
        <input type="text" id="representante" placeholder="Representante" required><br><br>

        <label for="razaosocial">Razão Social:</label>
        <input type="text" id="razaosocial" placeholder="Razão Social" required><br><br>

        <label for="cnpj">CNPJ:</label>
        <input type="text" id="cnpj" placeholder="CNPJ" required><br><br>

        <label for="telefone">Telefone:</label>
        <input type="text" id="telefone" placeholder="Telefone" required><br><br>

        <label for="email">E-mail:</label>
        <input type="email" id="email" placeholder="E-mail" required><br><br>

        <button type="submit">Cadastrar</button>
    </form>

    <script>

document.getElementById('cadastroForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Get input values from the form
    const representante = document.getElementById('representante').value;
    const razaosocial = document.getElementById('razaosocial').value;
    const cnpj = document.getElementById('cnpj').value;
    const telefone = document.getElementById('telefone').value;
    const email = document.getElementById('email').value;

    // Get the logged-in username from localStorage (if available)
    const loggedInUsername = localStorage.getItem('username');

    // Check if the CNPJ already exists
    const customerExists = await checkIfCNPJExists(cnpj);
    
    if (customerExists) {
        // If CNPJ exists, update the existing customer
        await updateCadastro(cnpj, representante, razaosocial, telefone, email, loggedInUsername);
    } else {
        // If CNPJ doesn't exist, create a new customer
        await createCadastro(representante, razaosocial, cnpj, telefone, email, loggedInUsername);
    }
});

// Function to check if the CNPJ already exists in the database
async function checkIfCNPJExists(cnpj) {
    try {
        const response = await fetch(`https://backendnyrfestas.vercel.app/customers?cnpj=${cnpj}`);
        const result = await response.json();

        // If any customer with the same CNPJ exists, return true
        return result.data && result.data.length > 0;
    } catch (error) {
        console.error('Erro ao verificar CNPJ:', error);
        alert('Erro ao verificar o CNPJ. Por favor, tente novamente.');
        return false;
    }
}

// Function to create a new Cadastro
async function createCadastro(representante, razaosocial, cnpj, telefone, email, username) {
    const customerData = {
        representante: representante,
        razaosocial: razaosocial,
        cnpj: cnpj,
        telefone: telefone,
        email: email,
        username: username // Associate this cadastro with the logged-in user
    };

    try {
        const response = await fetch('https://backendnyrfestas.vercel.app/cadastro', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(customerData)
        });

        const result = await response.json();

        if (response.ok) {
            alert("Cadastro realizado com sucesso!");
            // Reset the form after successful submission
            document.getElementById('cadastroForm').reset();
        } else {
            alert("Erro ao cadastrar: " + result.error || "Tente novamente.");
        }
    } catch (error) {
        console.error('Erro ao cadastrar cliente:', error);
        alert('Erro ao cadastrar cliente. Por favor, tente novamente.');
    }
}

// Function to update an existing Cadastro
async function updateCadastro(cnpj, representante, razaosocial, telefone, email, username) {
    const customerData = {
        representante: representante,
        razaosocial: razaosocial,
        cnpj: cnpj,
        telefone: telefone,
        email: email,
        username: username // Associate this cadastro with the logged-in user
    };

    try {
        const response = await fetch(`https://backendnyrfestas.vercel.app/cadastro/${cnpj}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(customerData)
        });

        const result = await response.json();

        if (response.ok) {
            alert("Cadastro atualizado com sucesso!");
            // Reset the form after successful update
            document.getElementById('cadastroForm').reset();
        } else {
            alert("Erro ao atualizar: " + result.error || "Tente novamente.");
        }
    } catch (error) {
        console.error('Erro ao atualizar cadastro:', error);
        alert('Erro ao atualizar cadastro. Por favor, tente novamente.');
    }
}


    </script>
</body>
</html>
