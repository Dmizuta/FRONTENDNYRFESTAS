<!DOCTYPE html>
<html lang="pt-BR">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - NYR Festas</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="/imagens/LOGO_NYR.png">
</head>

</html>


<style>
    /* Styling for the Cadastro form */








/* Styling for the customer list container */
#customer-list-container {
    max-width: 100%;
    margin: 20px auto;
    padding: 20px;
    background-color: #f1f1f1;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

#customer-list-container h3 {
    margin-bottom: 10px;
    color: #333;
}

#customer-list {
    list-style-type: none;
    padding: 0;
    margin: 0;
}

#customer-list li {
    padding: 10px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

#customer-list li:hover {
    background-color: #e6f7ff;
}

/* Styling for the search bar */
#searchBox {
    width:100%;
    padding-top: 20px;
    margin-right: 10px;
   
    border-radius: 5px;
    box-sizing: border-box;
    font-size: 14px;
}




#searchInput {
    width:100%;
    padding: 10px;
    margin-right: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
    font-size: 14px;
}



button[onclick="searchCustomers()"] {
    padding: 10px 15px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

button[onclick="searchCustomers()"]:hover {
    background-color: #218838;
}

</style>
<body>
    <header>
        <h1>NYR Festas</h1>
        <div id="user-info">
            <span id="username-display"></span>
            <button id="logoutBtn" aria-label="Logout do usuário">Logout</button>
        </div>
    </header>

    <nav>
        <ul>
            <li id="cadastro-link"><a href="#">Cadastro</a></li>
            <li><a href="produtos.html">Lista de Produtos</a></li>
            <li id="pedidos-link"><a href="#">Pedidos</a></li>
        </ul>
    </nav>

    <section class="pagina">
        <h2>Cadastro de Cliente REPRESENTANTE</h2>

        <!-- Form for New Customer Entry or Editing -->
        <form id="cadastroForm" class="cadastro-form">
            <label for="representante">Representante:</label>
            <input type="text" id="representante" name="representante" placeholder="Nome do Representante" required>

            <label for="razaosocial">Razão Social:</label>
            <input type="text" id="razaosocial" name="razaosocial" placeholder="Razão Social da empresa" required>

            <label for="cnpj">CNPJ:</label>
            <input type="text" id="cnpj" name="cnpj" placeholder="xx.xxx.xxx/xxxx-xx" required>

            <label for="telefone">Telefone:</label>
            <input type="text" id="telefone" name="telefone" placeholder="(xx) xxxxx-xxxx" required>

            <label for="email">E-mail:</label>
            <input type="email" id="email" name="email" placeholder="E-mail" required>

            <button type="submit" id="cadastroButton">Cadastrar</button>
        </form>

        <div id="searchBox">
            <input type="text" id="searchInput" placeholder="Search by name or CNPJ">
            
        </div>

        <div id="customer-list-container">
            <h3>Lista de Clientes</h3>
            <ul id="customer-list"></ul>
            <ul id="customer-list"></ul>

        </div>
        
        

        <!-- Customer List -->
        

    </section>

    <script>

        window.addEventListener('DOMContentLoaded', async () => {
            const loggedInUsername = localStorage.getItem('username');
            
            if (!loggedInUsername) {
                console.error("No username found in localStorage.");
                return;
            }
        


             // Handle login status
 const usuario = localStorage.getItem('username');
        if (usuario) {
            document.getElementById('username-display').textContent = `Bem-vindo, ${usuario}`;
        } else {
            alert("Você precisa estar logado para acessar esta página!");
            window.location.href = '/';
        }

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('username');
            window.location.href = '/';
        });










// Fetch customers linked to the logged-in user (seller)
const response = await fetch(`https://backendnyrfestas.vercel.app/customers?username=${loggedInUsername}`);
const result = await response.json();

if (result.success && result.data) {
    populateCustomerList(result.data);
}}
)




// Function to display the customer list
function populateCustomerList(customers) {
    const customerListContainer = document.getElementById('customer-list');
    customerListContainer.innerHTML = ''; // Clear any previous results

    customers.forEach(customer => {
        const listItem = document.createElement('li');
        listItem.textContent = `${customer.razaosocial} - ${customer.cnpj}`;
        listItem.addEventListener('click', () => loadCustomerData(customer));
        customerListContainer.appendChild(listItem);
    });
}

// Function to load customer data into the form when clicked
function loadCustomerData(customer) {
    document.getElementById('representante').value = customer.representante || '';
    document.getElementById('razaosocial').value = customer.razaosocial || '';
    document.getElementById('cnpj').value = customer.cnpj || '';
    document.getElementById('telefone').value = customer.telefone || '';
    document.getElementById('email').value = customer.email || '';
    document.getElementById('cadastroButton').textContent = 'Atualizar';  // Change button to 'Update'
    document.getElementById('cadastroForm').dataset.customerId = customer.id; // Store customer ID

    // Store customerId in localStorage
    localStorage.setItem('customerId', customer.customerId);  // Set customerId in localStorage
}





/*
            // Fetch customers linked to the logged-in user (seller)
            const response = await fetch(`https://backendnyrfestas.vercel.app/customers?username=${loggedInUsername}`);
            const result = await response.json();

            if (result.success && result.data) {
                populateCustomerList(result.data);
            }
        });

        // Function to display the customer list
        function populateCustomerList(customers) {
            const customerListContainer = document.getElementById('customer-list');
            customerListContainer.innerHTML = ''; // Clear any previous results

            customers.forEach(customer => {
                const listItem = document.createElement('li');
                listItem.textContent = `${customer.razaosocial} - ${customer.cnpj}`;
                listItem.addEventListener('click', () => loadCustomerData(customer));
                customerListContainer.appendChild(listItem);
            });
        }

        // Function to load customer data into the form when clicked
        function loadCustomerData(customer) {
            document.getElementById('representante').value = customer.representante || '';
            document.getElementById('razaosocial').value = customer.razaosocial || '';
            document.getElementById('cnpj').value = customer.cnpj || '';
            document.getElementById('telefone').value = customer.telefone || '';
            document.getElementById('email').value = customer.email || '';
            document.getElementById('cadastroButton').textContent = 'Atualizar';  // Change button to 'Update'
            document.getElementById('cadastroForm').dataset.customerId = customer.id; // Store customer ID
        }

*/



        // Handle search input event
        document.getElementById('searchInput').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const loggedInUsername = localStorage.getItem('username');

            const response = await fetch(`https://backendnyrfestas.vercel.app/customers?username=${loggedInUsername}`);
            const result = await response.json();

            if (result.success && result.data) {
                const filteredCustomers = result.data.filter(customer => 
                    customer.razaosocial.toLowerCase().includes(searchTerm) || 
                    customer.cnpj.toLowerCase().includes(searchTerm)
                );
                populateCustomerList(filteredCustomers);
            }
        });



// Handle form submission (Create or Update)
const form = document.getElementById('cadastroForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const loggedInUsername = localStorage.getItem('username');  // Get the logged-in username

    const formData = {
        representante: document.getElementById('representante').value,
        razaosocial: document.getElementById('razaosocial').value,
        cnpj: document.getElementById('cnpj').value,
        telefone: document.getElementById('telefone').value,
        email: document.getElementById('email').value,
        username: loggedInUsername,
    };

    // Retrieve the customer ID from the form's data attribute (if it's an existing customer)
    const customerId = form.dataset.customerId;

    try {
        let response;

        if (customerId) {
            // Update existing customer
            response = await fetch(`https://backendnyrfestas.vercel.app/updatecadastro/${customerId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            });
        } else {
            // Create new customer (assuming the backend has this route)
            response = await fetch('https://backendnyrfestas.vercel.app/cadastrorep', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            });
        }

        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);  // Shows a dynamic message like "Customer created successfully."
            form.reset();
            form.dataset.customerId = '';  // Clear stored customer ID after submission
            document.getElementById('cadastroButton').textContent = 'Cadastrar';  // Reset button text
        } else {
            alert('Error: ' + (result.error || 'Failed to process the request.'));
        }
    } catch (error) {
        console.error('Error submitting the form:', error);
        alert('Error processing the form. Please try again later.');
    }
});




        


       


  // Fetch the user's role from localStorage
  const userRole = localStorage.getItem('role'); // Ensure this is set at login
  const pedidosLink = document.getElementById('pedidos-link').querySelector('a');
  const cadastroLink = document.getElementById('cadastro-link').querySelector('a');


  
  // Dynamically assign the correct href based on the user's role
  if (userRole === 'USER') {
    pedidosLink.href = 'pedidos.html';
    cadastroLink.href = 'cadastro.html';
  } else if (userRole === 'SELLER') {
    pedidosLink.href = 'pedidosrep.html';
    cadastroLink.href = 'cadastrorep.html';
  } else if (userRole === 'ADMIN') {
    pedidosLink.href = 'pedidosadmin.html';
    cadastroLink.href = 'cadastroadmin.html';
  } else {
    pedidosLink.href = '#'; // Default action for unknown or missing roles
    console.warn('Role not defined or invalid.');
  }



    </script>
</body>
</html>
